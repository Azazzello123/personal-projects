#!/bin/bash

sudo apt update

sudo apt install apache2 -y

sudo apt install mysql-server -y

sudo mysql_secure_installation

sudo systemctl start mysql

sudo apt install php libapache2-mod-php php-mysql -y

sudo systemctl restart apache2

sudo apt install phpmyadmin -y

sudo bash -c 'echo "Include /etc/phpmyadmin/apache.conf" >> /etc/apache2/apache2.conf'

sudo systemctl restart apache2

USER="wordpressuser"
PASSWORD="StrongPass1!"

if ! sudo mysql -e "SELECT user FROM mysql.user WHERE user='${USER}';" | grep "${USER}"; then
    sudo mysql -e "CREATE USER '${USER}'@'localhost' IDENTIFIED BY '${PASSWORD}';"
    sudo mysql -e "GRANT ALL PRIVILEGES ON *.* TO '${USER}'@'localhost' WITH GRANT OPTION;"
    sudo mysql -e "FLUSH PRIVILEGES;"
else
    echo "MySQL user '${USER}' already exists."
fi

cd /tmp
wget https://wordpress.org/latest.tar.gz
tar -xvf latest.tar.gz

sudo cp -r --update=none wordpress/* /var/www/html/

sudo chown -R www-data:www-data /var/www/html/
sudo chmod -R 755 /var/www/html/

sudo a2enmod rewrite
sudo systemctl restart apache2

DB_EXISTS=$(sudo mysql -e "SHOW DATABASES LIKE 'wordpress';" | grep "wordpress")
if [ -z "$DB_EXISTS" ]; then
    sudo mysql -e "CREATE DATABASE wordpress;"
else
    echo "Database 'wordpress' already exists."
fi

echo "Please navigate to your server's IP address to complete the WordPress setup through the web interface."


sudo ufw allow 80/tcp
sudo ufw allow 443/tcp
sudo ufw reload
